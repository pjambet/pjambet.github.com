<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Emojis and MySQL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="description" content="" />
    
    <meta name="author" content="Pierre Jambet">
    <link href="/css/bootstrap.css" rel="stylesheet">
    <link href="/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="/css/docs.css" rel="stylesheet">
    <link href="/css/3rd_party/pygments/default.css" rel="stylesheet">
    <link href="/js/google-code-prettify/prettify.css" rel="stylesheet">
	<link rel="shortcut icon" href="/favicon.ico">
  </head>
  <body data-spy="scroll" data-target=".subnav" data-offset="50">
	<div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
	<div class="container">
	  <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
		<span class="icon-bar"></span>
		<span class="icon-bar"></span>
		<span class="icon-bar"></span>
	  </a>
	  <a class="brand" href="http://pjambet.github.com">Another developer blog</a>
	  <div class="nav-collapse">
		<ul class="nav">
		  <li class="">
			<a href="http://pjambet.github.com"><i class="icon-home"></i> Home</a>
		  </li>
		  <li class="dropdown">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="icon-comment"></i> Social <b class="caret"></b></a>
				<ul class="dropdown-menu">
					<li class=""><a href="http://www.twitter.com/pierre_jambet" rel="tooltip" title="Go to twitter.com/pierre_jambet" target="_blank">Twitter</a></li>
					<li class=""><a href="http://github.com/pjambet" rel="tooltip" title="Go to github.com/pjambet" target="_blank">GitHub</a></li>
					<li class=""><a href="http://www.linkedin.com/profile/view?id=156041350" rel="tooltip" title="Go to LinkedIn profile" target="_blank">LinkedIn</a></li>
					<li class=""><a href="http://coderwall.com/pjambet" rel="tooltip" title="Go to coderwall/pjambet" target="_blank">Coderwall</a></li>
					<li class="divider"></li>
				</ul>
			 </li>
		<li class="dropdown">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="icon-list"></i> Projects <b class="caret"></b></a>
				<ul class="dropdown-menu">
					<li class=""><a href="https://github.com/pjambet/beech-server" rel="tooltip" title="Beech" target="_blank">Beech</a></li>
				</ul>
			 </li>
		</ul>
	  </div>
	</div>
  </div>
</div>

	<div class="container">
		<div class="marketing">
		<div class="content">
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		var disqus_shortname = 'githubpagepjambet'; // required: replace example with your forum shortname
		var disqus_identifier = '/blog/emojis-and-mysql';
		var disqus_url = 'http://pjambet.github.com/blog/emojis-and-mysql';

		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function () {
			var s = document.createElement('script'); s.async = true;
			s.type = 'text/javascript';
			s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
			(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
		}());
	</script>

<div class="row">
	<div class="span9 column">
		<p><h1>Emojis and MySQL</h1></p>
	</div>
</div>
<div class="row">
	<div class="span3 column">
		<h5><strong>August 28, 2013 <small>. App . <a href="http://pjambet.github.com/blog/emojis-and-mysql#disqus_thread" data-disqus-identifier="/blog/emojis-and-mysql">Comments</a></small></strong>
		<br/><small>Tags:  <a href="/tags/emojis" title="View posts tagged with &quot;emojis&quot;"><u>emojis</u></a>    <a href="/tags/mysql" title="View posts tagged with &quot;mysql&quot;"><u>mysql</u></a>    <a href="/tags/db" title="View posts tagged with &quot;db&quot;"><u>db</u></a>    </small><br/><br/>
		<a href="https://twitter.com/share" class="twitter-share-button" data-via="pierre_jambet">Tweet</a> <g:plusone size="medium"></g:plusone></h5>
	</div>
	<div class="span6 column">
		<p class="pull-right"> <a href="/blog/beech-is-here" title="Previous Post: Beech is finally here"><i class="icon-chevron-left"></i></a> 	    	<a href="/blog/atomic-operations-in-sql" title="Next Post: Atomic increment/decrement operations in SQL (and fun with locks)"><i class="icon-chevron-right"></i></a> 	 </p>
	</div>
</div>
<div class="row">
	<div class="span9 column">
		<hr>
	</div>
</div>


  <div class="row">
    <div class="span9 column">
      <p><strong>tl;dr; MySQL regular UTF8 encoding sucks, you should use UTF8mb4 (or even
better, Postgres !)</strong></p>

<h2>Intro</h2>

<p>In the past few months I had to struggle with MySQL and its crappy UTF8 support,
so I thought I would sum up my findings here.</p>

<p>If you&#39;ve seen stuff like</p>
<div class="highlight"><pre><code class="language-" data-lang="">Mysql::Error: Specified key was too long; max key length is 767 bytes
</code></pre></div>
<p>or</p>
<div class="highlight"><pre><code class="language-" data-lang="">Mysql2::Error: Incorrect string value: '\xF0\x9F\x8F\xA0' for column 'body' at row 1 ...
</code></pre></div>
<p>then maybe this article can help you.</p>

<h2>Technical details !</h2>

<p>Basically, in order to store the whole range of UTF8 characters, each chararacter
has to be 4 bytes wide. But MySQL, with its default UTF8 encoding will only
allocate 3 bytes per character.
This becomes a problem when users try to insert character such as emojis in your
database.
That might sound like an edge case, but if your app is an API where users can
post content through their phones, then it&#39;s really likely some people will add
emojis.</p>

<p>If you want a comprehensive guide for migrating your mysql database from utf8 to
utf8mb4, <a href="http://mathiasbynens.be/notes/mysql-utf8mb4">this article</a> contains
everything you need.</p>

<h2>How to use it in Rails and Django</h2>

<p>Using utf8mb4 is quite straight forward</p>

<h3>Django example :</h3>

<p>in your new project :</p>
<div class="highlight"><pre><code class="language-" data-lang="">$&gt; django-admin.py startproject test
</code></pre></div>
<p>Simply add the <code>charset</code> option in the <code>DATABASES</code> setting :</p>

<p><em>settings.py</em></p>
<div class="highlight"><pre><code class="language-" data-lang="">DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'test',
        'USER': 'test_user'
        'OPTIONS': {'charset': 'utf8mb4'},
        'PASSWORD': '',
        'HOST': '',
        'PORT': '',
    }
}
</code></pre></div>
<p>And you&#39;re good to go !</p>

<h4>Caveat</h4>

<p>There is still a problem with that configuration. Now the maximum length that
MySQL can index is <code>191</code> instead of <code>255</code>.
That won&#39;t be a problem if you apply this new limit on your models, but some
libraries, such as celery try to index some column with a 255 max length.</p>

<p>So if you have <code>djcelery</code> in your <code>INSTALLED_APPS</code>, running your migrations
(<code>python manage.py migrate</code>) will fail with a nice :</p>
<div class="highlight"><pre><code class="language-" data-lang="">django.db.utils.DatabaseError: (1071, 'Specified key was too long; max key length is 767 bytes')
</code></pre></div>
<p>The only solution I found so far is to only run migrations on an app per app
basis.</p>
<div class="highlight"><pre><code class="language-" data-lang="">python manage.py migrate myapp
python manage.py migrate anotherapp
</code></pre></div>
<p>and for the app that fails, such as <code>djcelery</code>, first run</p>

<p><code>python manage.py sqall djcelery</code></p>

<p>Which should give you an output similar to :</p>
<div class="highlight"><pre><code class="language-" data-lang="">BEGIN;
CREATE TABLE `celery_taskmeta` (
    `id` integer AUTO_INCREMENT NOT NULL PRIMARY KEY,
    `task_id` varchar(255) NOT NULL UNIQUE,
    `status` varchar(50) NOT NULL,
    `result` longtext,
    `date_done` datetime NOT NULL,
    `traceback` longtext,
    `hidden` bool NOT NULL,
    `meta` longtext
)
;

# other CREATE TABLES ...

CREATE INDEX `djcelery_taskstate_c91f1bf` ON `djcelery_taskstate` (`hidden`);
COMMIT;
</code></pre></div>
<p>Then copy this in your favorite editor (vim, of course !), and specify the
<code>CHARACTER SET</code> as <code>utf8</code> for each table. This should not cause any issues, as
all the data that is gonna be inserted in those tables is controlled by celery
itself, and there should not be any emojis are other 4 bytes wide characters.</p>

<p>Then your new file should look like :</p>
<div class="highlight"><pre><code class="language-" data-lang="">BEGIN;
CREATE TABLE `celery_taskmeta` (
    `id` integer AUTO_INCREMENT NOT NULL PRIMARY KEY,
    `task_id` varchar(255) NOT NULL UNIQUE,
    `status` varchar(50) NOT NULL,
    `result` longtext,
    `date_done` datetime NOT NULL,
    `traceback` longtext,
    `hidden` bool NOT NULL,
    `meta` longtext
) CHARACTER SET=utf8 # Note the CHARACTER SET explictly set
;

# ... and the rest
</code></pre></div>
<p>PS : I&#39;ve opened <a href="https://github.com/celery/django-celery/issues/259">an issue on
github</a>, and I am still
waiting for more information
about this problem.</p>

<h3>Rails example :</h3>

<p>Note that utf8mb4 support in rails is <a href="https://github.com/rails/rails/issues/9855">really
recent</a>, and is only supported since
rails 4.0.0</p>

<p>in your new rails project :</p>
<div class="highlight"><pre><code class="language-" data-lang="">$&gt; rails new test -d mysql
</code></pre></div>
<p><em>database.yml</em></p>
<div class="highlight"><pre><code class="language-" data-lang=""># MySQL.  Versions 4.1 and 5.0 are recommended.
#
# Install the MYSQL driver
#   gem install mysql2
#
# Ensure the MySQL gem is defined in your Gemfile
#   gem 'mysql2'
#
# And be sure to use new-style password hashing:
#   http://dev.mysql.com/doc/refman/5.0/en/old-client.html
development:
  adapter: mysql2
  encoding: utf8mb4
  database: test_development
  pool: 5
  username: root
  password:
  socket: /tmp/mysql.sock

# Warning: The database defined as "test" will be erased and
# re-generated from your development database when you run "rake".
# Do not set this db to the same as development or production.
test:
  adapter: mysql2
  encoding: utf8mb4
  database: test_test
  pool: 5
  username: root
  password:
  socket: /tmp/mysql.sock

production:
  adapter: mysql2
  encoding: utf8mb4
  database: test_production
  pool: 5
  username: root
  password:
  socket: /tmp/mysql.sock
</code></pre></div>
<h2>Use postgresql if you can !</h2>

<p>This won&#39;t really help you if you&#39;re stuck with MySQL. In my case, I had to use
AWS and had to use MySQL. Even if it&#39;s possible to use postgresql on AWS, using
RDS has many advantages, such as the ease of setup and configuration.</p>

<p>So if you have the choice, use postgresql ! I haven&#39;t seen any advantages of
MySQL over postgresql.</p>

<p>Postgres UTF8 encoding works like a charm (and it should be the same for every
RDBMS), that means no encoding, collation or index length headaches. It just
works !</p>

<p>And of course if you start using posgresql, you&#39;ll discover a bunch of amazing
features such as <a href="http://www.postgresql.org/docs/9.1/static/arrays.html">array
columns</a>,
<a href="http://www.postgresql.org/docs/9.1/static/hstore.html">hstore</a> and many other
really awesome stuff !</p>

<div class="row">
	<div class="span9 column">
			<p class="pull-right"> <a href="/blog/beech-is-here" title="Previous Post: Beech is finally here"><i class="icon-chevron-left"></i></a> 	    	<a href="/blog/atomic-operations-in-sql" title="Next Post: Atomic increment/decrement operations in SQL (and fun with locks)"><i class="icon-chevron-right"></i></a> 	 </p>
	</div>
</div>

<div class="row">
    <div class="span9 columns">
		<h2>Comments Section</h2>
	    <p>Feel free to comment on the post but keep it clean and on topic.</p>
		<div id="disqus_thread"></div>
		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
			var disqus_shortname = 'githubpagepjambet'; // required: replace example with your forum shortname
			var disqus_identifier = '/blog/emojis-and-mysql';
			var disqus_url = 'https://pjambet.github.com/blog/emojis-and-mysql';

			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="https://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
	</div>
</div>

<!-- Twitter -->
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </div>
  </div>
</div>


		</div>
	 </div>
	<footer class="footer">
  <div class="container">
	<p class="pull-right"> <a href="/blog/beech-is-here" title="Previous Post: Beech is finally here">&laquo; Previous Blog Post</a> 	  |  <a href="#">Back to top</a>  |   	<a href="/blog/atomic-operations-in-sql" title="Next Post: Atomic increment/decrement operations in SQL (and fun with locks)">Next Blog Post &raquo; </a> 	 </p>
	<p>Page last generated on July 23, 2019</p>
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </div>
</footer>

    <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    <script src="/js/jquery.js"></script>
    <script src="/js/google-code-prettify/prettify.js"></script>
    <script src="/js/bootstrap-transition.js"></script>
    <script src="/js/bootstrap-alert.js"></script>
    <script src="/js/bootstrap-modal.js"></script>
    <script src="/js/bootstrap-dropdown.js"></script>
    <script src="/js/bootstrap-scrollspy.js"></script>
    <script src="/js/bootstrap-tab.js"></script>
    <script src="/js/bootstrap-tooltip.js"></script>
    <script src="/js/bootstrap-popover.js"></script>
    <script src="/js/bootstrap-button.js"></script>
    <script src="/js/bootstrap-collapse.js"></script>
    <script src="/js/bootstrap-carousel.js"></script>
    <script src="/js/bootstrap-typeahead.js"></script>
    <script src="/js/application.js"></script>
	<script src="/js/custom.js" type="text/javascript"></script>

	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		var disqus_shortname = 'githubpagepjambet'; // required: replace example with your forum shortname

		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function () {
			var s = document.createElement('script'); s.async = true;
			s.type = 'text/javascript';
			s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
			(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
		}());
	</script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-35058499-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-35058499-1');
</script>

  </body>
</html>
